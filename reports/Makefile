
DB=../wr.db

SQLFILES=$(wildcard *.sql)
CSVFILES=$(patsubst %.sql,%.csv,$(SQLFILES))

GPFILES=$(wildcard *.gnuplot)
PNGFILES=$(patsubst %.gnuplot,%.png,$(GPFILES))
MDFILES=report-lastmonth.md report-thismonth.md

all: reports charts md

reports: $(CSVFILES)
charts: $(PNGFILES)
md: $(MDFILES)

clean:
	rm -f $(CSVFILES) $(PNGFILES) *~

report-lastmonth.md: report-lastmonth.sh tot-lastmonth.csv page-daily-lastmonth.png user-lastmonth.csv
	sh report-lastmonth.sh lastmonth > $@ || rm -f $@
report-thismonth.md: report-lastmonth.sh tot-thismonth.csv page-daily-thismonth.png user-thismonth.csv
	sh report-lastmonth.sh thismonth > $@ || rm -f $@

# need this data for each chart
user-first-last.png: user-alltime.csv
user-first-len.png: user-alltime.csv
page-monthly.gnuplot: tot-monthly.csv
user-monthly.gnuplot: tot-monthly.csv

# these two charts are generated by the same gnuplot file from different data sources
page-daily-thismonth.png: page-daily.gnuplot tot-thismonth-daily.csv
	gnuplot -e "filename='tot-thismonth-daily.csv'; set terminal png; set output '$@';" page-daily.gnuplot || rm -f $@
page-daily-lastmonth.png: page-daily.gnuplot tot-lastmonth-daily.csv
	gnuplot -e "filename='tot-lastmonth-daily.csv'; set terminal png; set output '$@';" page-daily.gnuplot || rm -f $@
page-daily.png:
	@true
page-annually.png: page-annually.gnuplot tot-annually.csv
page-monthly.png: page-monthly.gnuplot tot-monthly.csv
score-monthly.png: score-monthly.gnuplot tot-monthly.csv
user-first-last.png: user-first-last.gnuplot user-alltime.csv
user-first-len.png: user-first-len.gnuplot user-alltime.csv
user-monthly.png: user-monthly.gnuplot tot-monthly.csv
user-tenure.png: user-tenure.gnuplot user-alltime.csv

verdump.csv:
	(echo '.mode csv'; echo '.headers on'; echo 'select * from vers') | sqlite3 $(DB) > $@
%.csv: %.sql
	sqlite3 $(DB) < $< > $@ || rm -f $@
%.png: %.gnuplot
	gnuplot -e "set terminal png; set output '$@'" $< || rm -f $@
%.svg: %.gnuplot
	gnuplot -e "set terminal svg; set output '$@'" $< || rm -f $@
